# Phase 6 实现计划 — 幻彩星 + 暗物质星 + 生命感

> 版本：v1.0 | 日期：2026-02-19
> 制定人：小栈
> 状态：待小西和 Charles 确认

---

## 总览

Phase 6 是农场系统的最后阶段，将实现五行融合、幻彩星、暗物质星、天气系统、每周刷新商城等终极内容。

**拆分策略：** 分为 4 个独立的 Step，每个 Step 可独立验收和发版。

**总预估工期：** 8-10 天

---

## Step 1：五行融合 + 幻彩星（v0.33.0）

### 目标
实现五行融合机制和幻彩星 5 个品种，让用户能通过策略性收集基因来获得终极品种。

### 子任务

#### 1.1 数据结构设计
- [ ] 扩展 `GalaxyId` 类型，新增 `'prismatic'`（幻彩星）
- [ ] 扩展 `VARIETY_DEFS`，新增 5 个幻彩品种：
  - 棱镜瓜（⭐⭐，150💰）
  - 泡泡瓜（⭐⭐，150💰）
  - 星云瓜（⭐⭐⭐，600💰）
  - 极光瀑瓜（⭐⭐⭐，600💰）
  - 梦境瓜（⭐⭐⭐⭐，2000💰）
- [ ] 新增 `PrismaticSeed` 类型（幻彩种子，带品种ID）
- [ ] 扩展 `ShedStorage.prismaticSeeds: PrismaticSeed[]`
- [ ] 新增 `FarmStorage.prismaticPity: number`（保底计数器）

#### 1.2 五行融合逻辑
- [ ] 实现 `canFuseFiveElements(fragments: GeneFragment[]): boolean`
  - 检查是否有 5 个星系各 ≥1 个基因片段
- [ ] 实现 `fuseFiveElements(fragments: GeneFragment[], useModifier: boolean): FusionResult`
  - 基础成功率 50%
  - 稀有度加成：⭐+0% / ⭐⭐+10% / ⭐⭐⭐+20% / ⭐⭐⭐⭐+30%
  - 改造液 +20%
  - 失败返还 1 份随机基因
  - 成功产出幻彩种子（5 个品种按掉率随机）
- [ ] 实现保底机制：
  - 同品种重复 3 次后，下次必出新品种
  - 保底计数器存储在 `FarmStorage.prismaticPity`

#### 1.3 幻彩星生长机制
- [ ] 幻彩种子成熟时间：50000 分钟
- [ ] 幻彩不枯萎，只暂停：
  - 超过 72 小时不活跃，进度倒退 5%/天
  - 最多倒退 50%
  - 重新活跃后恢复正常生长
- [ ] 修改 `updatePlotGrowth` 逻辑，支持幻彩品种的特殊规则

#### 1.4 UI 实现
- [ ] 基因实验室新增"五行融合"操作区（第三个区域）
  - 显示五行共鸣条件（5 个星系各 ≥1 基因）
  - 条件满足时显示"五行融合"按钮
  - 融合界面：选择 5 个基因（每个星系 1 个）+ 改造液开关
  - 显示成功率（基础 50% + 稀有度加成 + 改造液）
  - 融合动画（成功/失败）
- [ ] 图鉴新增幻彩星页面
  - 星系图标：🌈
  - 5 个品种卡片
  - 品种详情页（故事、首次获得、累计收获）
- [ ] 瓜棚新增幻彩种子分类
  - 显示品种名称（不是"幻彩种子 x3"）
  - 种植时直接种下对应品种

#### 1.5 i18n
- [ ] 8 种语言文案（zh/en/ja/ko/de/fr/es/pt）
  - 五行融合相关（按钮、提示、成功/失败消息）
  - 幻彩星品种名称和故事
  - 幻彩生长机制提示

### 技术方案

**数据流：**
1. 用户在基因实验室选择 5 个基因（每个星系 1 个）
2. 点击"五行融合"按钮
3. 调用 `fuseFiveElements`，消耗 5 个基因 + 可选改造液
4. 按成功率判定：
   - 成功：产出幻彩种子（按掉率随机品种），更新保底计数器
   - 失败：返还 1 份随机基因
5. 幻彩种子存储在 `shed.prismaticSeeds`
6. 种植时从 `prismaticSeeds` 消耗，种下对应品种

**与现有代码集成点：**
- `src/types/farm.ts`：扩展类型定义
- `src/farm/galaxy.ts`：新增幻彩星解锁逻辑（五行共鸣条件）
- `src/hooks/useShedStorage.ts`：新增 `prismaticSeeds` 管理
- `src/hooks/useFarmStorage.ts`：新增 `prismaticPity` 管理
- `src/components/GeneLabPage.tsx`：新增五行融合 UI
- `src/components/WarehousePage.tsx`：新增幻彩种子展示
- `src/components/FarmPage.tsx`：支持幻彩品种种植和生长

### 验收标准
- [ ] 五行共鸣条件达成后"五行融合"按钮出现
- [ ] 融合成功率计算正确（基础 50% + 稀有度加成 + 改造液）
- [ ] 融合失败返还 1 份随机基因
- [ ] 保底机制：同品种重复 3 次后必出新品种
- [ ] 幻彩种子种下后正确生长，成熟时间 50000 分钟
- [ ] 幻彩品种超过 72 小时不活跃，进度倒退 5%/天，最多 50%
- [ ] 图鉴正确显示幻彩星 5 个品种
- [ ] E2E 测试覆盖五行融合全流程（成功/失败/保底）

### 预估工期
3-4 天

---

## Step 2：暗物质星 + 终极动画（v0.34.0）

### 目标
实现暗物质星 3 个品种（虚空瓜、黑洞瓜、宇宙之心），完成整个西瓜宇宙的收集线。

### 子任务

#### 2.1 数据结构设计
- [ ] 扩展 `GalaxyId` 类型，新增 `'dark-matter'`（暗物质星）
- [ ] 扩展 `VARIETY_DEFS`，新增 3 个暗物质品种：
  - 虚空瓜（⭐⭐⭐，1000💰）
  - 黑洞瓜（⭐⭐⭐⭐，5000💰）
  - 宇宙之心（👑 隐藏，不可出售）
- [ ] 新增 `DarkMatterSeed` 类型（暗物质种子，带品种ID）
- [ ] 扩展 `ShedStorage.darkMatterSeeds: DarkMatterSeed[]`

#### 2.2 暗物质品种获取逻辑
- [ ] 虚空瓜：5 颗幻彩基因融合（100% 成功）
  - 实现 `fuseVoidMelon(fragments: GeneFragment[]): boolean`
  - 检查是否有 5 个幻彩星基因
  - 消耗 5 个基因，产出虚空瓜种子
- [ ] 黑洞瓜：10 种双元素基因融合（100% 成功）
  - 实现 `fuseBlackHoleMelon(fragments: GeneFragment[]): boolean`
  - 检查是否有 10 种不同的双元素组合基因
  - 消耗 10 个基因，产出黑洞瓜种子
- [ ] 宇宙之心：全收集自动出现
  - 实现 `checkCosmicHeartUnlock(collection: CollectedVariety[]): boolean`
  - 检查是否收集了全部 78 个品种（5 星系 + 杂交 + 幻彩 + 虚空 + 黑洞）
  - 条件满足时自动产出宇宙之心种子 + 终极动画

#### 2.3 获取指引 UI
- [ ] 图鉴暗物质星页面显示获取条件：
  - 虚空瓜：需要 5 颗幻彩基因
  - 黑洞瓜：需要 10 种双元素基因
  - 宇宙之心：收集全部 78 个品种
- [ ] 未达成条件时显示进度（如"已收集 65/78 品种"）

#### 2.4 终极动画
- [ ] 宇宙之心解锁时播放全屏动画：
  - 所有品种图标从四周飞向中心
  - 汇聚成宇宙之心图标
  - 配合音效和震动（移动端）
  - 动画结束后显示祝贺文案
- [ ] 动画可跳过（点击屏幕）

#### 2.5 i18n
- [ ] 8 种语言文案
  - 暗物质星品种名称和故事
  - 获取指引文案
  - 终极动画祝贺文案

### 技术方案

**数据流：**
1. 虚空瓜：用户在基因实验室选择 5 个幻彩基因 → 融合 → 产出虚空瓜种子
2. 黑洞瓜：用户在基因实验室选择 10 个不同双元素基因 → 融合 → 产出黑洞瓜种子
3. 宇宙之心：后台检测收集进度 → 达到 78 品种 → 自动触发终极动画 → 产出宇宙之心种子

**与现有代码集成点：**
- `src/types/farm.ts`：扩展类型定义
- `src/hooks/useShedStorage.ts`：新增 `darkMatterSeeds` 管理
- `src/components/GeneLabPage.tsx`：新增虚空瓜和黑洞瓜融合 UI
- `src/components/WarehousePage.tsx`：新增暗物质种子展示
- `src/App.tsx`：新增宇宙之心解锁检测和终极动画触发

### 验收标准
- [ ] 5 颗幻彩基因融合产出虚空瓜种子（100% 成功）
- [ ] 10 种双元素基因融合产出黑洞瓜种子（100% 成功）
- [ ] 收集全部 78 品种后自动触发终极动画
- [ ] 终极动画播放完毕后产出宇宙之心种子
- [ ] 图鉴正确显示暗物质星 3 个品种和获取条件
- [ ] E2E 测试覆盖暗物质品种获取全流程

### 预估工期
2-3 天

---

## Step 3：天气系统 + 生命感（v0.35.0）

### 目标
为瓜田增加天气系统和小动物装饰，让农场"活"起来，提升沉浸感。

### 子任务

#### 3.1 天气系统
- [ ] 新增 `WeatherType` 类型：`'sunny' | 'cloudy' | 'rainy' | 'night' | 'rainbow'`
- [ ] 扩展 `FarmStorage.currentWeather: WeatherType`
- [ ] 扩展 `FarmStorage.weatherChangeAt: number`（下次切换时间戳）
- [ ] 实现天气切换逻辑：
  - 每 6 小时随机切换一次
  - 权重：晴天 40% / 多云 25% / 雨天 15% / 夜晚 15% / 彩虹 5%
  - 彩虹只在雨天后出现（特殊规则）
- [ ] 天气视觉效果：
  - ☀️ 晴天：明亮背景 + 太阳图标
  - ☁️ 多云：灰色背景 + 云朵图标
  - 🌧️ 雨天：深灰背景 + 雨滴动画（CSS）
  - 🌙 夜晚：深蓝背景 + 月亮和星星
  - 🌈 彩虹：彩虹渐变背景 + 彩虹图标

#### 3.2 小动物装饰
- [ ] 新增 `CreatureType` 类型：`'bee' | 'butterfly' | 'ladybug' | 'bird'`
- [ ] 实现小动物出现逻辑：
  - 每 30 秒检测一次
  - 10% 概率出现一只小动物
  - 随机选择类型和位置（瓜田内随机地块附近）
  - 停留 5-10 秒后消失
- [ ] 小动物视觉效果：
  - 🐝 蜜蜂：飞行动画（CSS）
  - 🦋 蝴蝶：飘动动画
  - 🐞 瓢虫：爬行动画
  - 🐦 小鸟：跳跃动画
- [ ] 小动物不影响游戏逻辑，纯装饰

#### 3.3 外星人系统（可选，时间充裕时实现）
- [ ] 新增 `AlienType` 类型：`'melon-alien' | 'mutation-doctor'`
- [ ] 实现外星人出现逻辑：
  - 每 1 小时检测一次
  - 5% 概率出现
  - 显示对话气泡（随机文案）
  - 停留 10 秒后消失
- [ ] 外星人视觉效果：
  - 瓜瓜星人：可爱外星人图标 + 对话气泡
  - 变异博士：科学家图标 + 对话气泡

#### 3.4 UI 实现
- [ ] 瓜田顶部显示当前天气图标
- [ ] 天气切换时播放过渡动画
- [ ] 小动物和外星人以绝对定位叠加在瓜田上
- [ ] 响应式适配（移动端和桌面端）

#### 3.5 i18n
- [ ] 8 种语言文案
  - 天气名称
  - 外星人对话文案（每种 5-10 条随机）

### 技术方案

**数据流：**
1. 后台定时检测天气切换时间 → 达到切换时间 → 随机选择新天气 → 更新 `currentWeather`
2. 后台定时检测小动物出现 → 随机判定 → 出现小动物 → 5-10 秒后消失
3. 后台定时检测外星人出现 → 随机判定 → 出现外星人 + 对话 → 10 秒后消失

**与现有代码集成点：**
- `src/types/farm.ts`：扩展类型定义
- `src/hooks/useFarmStorage.ts`：新增天气管理
- `src/components/FarmPage.tsx`：新增天气和小动物渲染
- `src/App.tsx`：新增定时检测逻辑

### 验收标准
- [ ] 天气每 6 小时随机切换一次
- [ ] 天气视觉效果正确显示（背景、图标、动画）
- [ ] 小动物随机出现并播放动画
- [ ] 外星人随机出现并显示对话气泡
- [ ] 天气和小动物不影响游戏逻辑
- [ ] E2E 测试覆盖天气切换和小动物出现

### 预估工期
2-3 天

---

## Step 4：每周刷新商城（v0.36.0）

### 目标
实现每周刷新的特殊货架，提供稀有基因片段、传说种子、限定装饰等商品。

### 子任务

#### 4.1 数据结构设计
- [ ] 新增 `WeeklyShopItem` 类型：
  ```typescript
  type WeeklyShopItem = {
    id: string;
    type: 'gene' | 'seed' | 'decoration';
    itemId: string; // 基因片段ID / 品种ID / 装饰ID
    price: number;
    stock: number; // 库存（-1 表示无限）
  };
  ```
- [ ] 扩展 `MarketStorage.weeklyShop: WeeklyShopItem[]`
- [ ] 扩展 `MarketStorage.weeklyShopRefreshAt: number`（下次刷新时间戳）

#### 4.2 每周刷新逻辑
- [ ] 实现 `generateWeeklyShop(): WeeklyShopItem[]`
  - 随机生成 3-5 件商品
  - 商品类型分布：
    - 稀有基因片段（⭐⭐⭐/⭐⭐⭐⭐，200-500 瓜币）：40%
    - 传说种子（随机星系 ⭐⭐⭐ 品种，300 瓜币）：30%
    - 限定装饰（瓜田装饰物，100-200 瓜币）：30%
  - 每件商品库存 1-3 个
- [ ] 实现刷新时间检测：
  - 每周一 00:00 UTC 刷新
  - 后台定时检测 `weeklyShopRefreshAt`
  - 达到刷新时间 → 调用 `generateWeeklyShop()` → 更新 `weeklyShop`

#### 4.3 装饰系统（简化版）
- [ ] 新增 `DecorationType` 类型：`'fence' | 'lamp' | 'statue' | 'fountain'`
- [ ] 扩展 `ShedStorage.decorations: Record<DecorationType, number>`
- [ ] 装饰物暂不实现放置功能，仅作为收藏品
- [ ] 图鉴新增装饰页面（展示已拥有的装饰）

#### 4.4 UI 实现
- [ ] 商城新增"每周特惠"tab
- [ ] 显示刷新倒计时（距离下周一 00:00 UTC）
- [ ] 商品卡片显示：
  - 商品图标 + 名称 + 价格
  - 库存数量（已售 X/总库存 Y）
  - 购买按钮（库存为 0 时置灰）
- [ ] 购买后库存 -1，瓜币 -price，商品进入背包

#### 4.5 i18n
- [ ] 8 种语言文案
  - 每周特惠 tab 名称
  - 刷新倒计时文案
  - 装饰物名称和描述

### 技术方案

**数据流：**
1. 后台定时检测刷新时间 → 达到每周一 00:00 UTC → 调用 `generateWeeklyShop()` → 更新 `weeklyShop`
2. 用户打开商城"每周特惠"tab → 显示当前商品列表
3. 用户购买商品 → 扣除瓜币 → 商品进入背包 → 库存 -1

**与现有代码集成点：**
- `src/types/market.ts`：扩展类型定义
- `src/hooks/useMarketStorage.ts`：新增每周商城管理
- `src/hooks/useShedStorage.ts`：新增装饰物管理
- `src/components/MarketPage.tsx`：新增每周特惠 tab
- `src/App.tsx`：新增刷新时间检测逻辑

### 验收标准
- [ ] 每周一 00:00 UTC 商城自动刷新
- [ ] 商品列表随机生成 3-5 件商品
- [ ] 购买后库存正确减少
- [ ] 库存为 0 时无法购买
- [ ] 刷新倒计时正确显示
- [ ] E2E 测试覆盖每周商城购买流程

### 预估工期
1-2 天

---

## 总工期估算

| Step | 内容 | 工期 | 累计 |
|------|------|------|------|
| Step 1 | 五行融合 + 幻彩星 | 3-4 天 | 3-4 天 |
| Step 2 | 暗物质星 + 终极动画 | 2-3 天 | 5-7 天 |
| Step 3 | 天气系统 + 生命感 | 2-3 天 | 7-10 天 |
| Step 4 | 每周刷新商城 | 1-2 天 | 8-12 天 |

**总计：8-12 天完成 Phase 6 全部内容。**

---

## 技术风险与缓解

### 风险 1：幻彩品种生长机制复杂
- **风险：** 幻彩不枯萎只暂停，进度倒退逻辑可能与现有枯萎机制冲突
- **缓解：** 在 `updatePlotGrowth` 中单独处理幻彩品种，不走枯萎分支

### 风险 2：终极动画性能问题
- **风险：** 全屏动画可能在低端设备上卡顿
- **缓解：** 使用 CSS 动画而非 JS 动画，提供跳过选项

### 风险 3：每周刷新时间计算
- **风险：** 时区转换可能导致刷新时间不准确
- **缓解：** 统一使用 UTC 时间，前端显示时转换为用户本地时间

### 风险 4：装饰系统扩展性
- **风险：** 装饰物暂不实现放置功能，未来扩展可能需要重构
- **缓解：** 数据结构预留扩展字段（如 `position`），UI 暂不实现

---

## 开发原则

1. **每个 Step 独立可发布**：不依赖后续 Step，用户每个 Step 都能体验到完整功能
2. **先核心逻辑，再视觉打磨**：优先实现功能逻辑，动画和视觉效果可后续优化
3. **数据结构预留扩展性**：为未来可能的功能（如装饰放置、天气影响生长）预留字段
4. **E2E 测试全覆盖**：每个 Step 完成后编写 E2E 测试，确保功能稳定
5. **i18n 同步更新**：每个 Step 完成后同步更新 8 种语言文案

---

## 后续优化方向（Phase 6 之后）

1. **装饰放置系统**：允许用户在瓜田放置装饰物，自定义农场外观
2. **天气影响生长**：不同天气影响生长速度（如雨天 +10%）
3. **外星人互动**：点击外星人触发小游戏或奖励
4. **成就系统扩展**：新增 Phase 6 相关成就（如"五行大师"、"宇宙收藏家"）
5. **社交功能**：好友系统、农场访问、礼物赠送

---

## 确认清单

- [ ] 小西确认：Step 拆分合理，验收标准清晰
- [ ] Charles 确认：功能优先级和工期预估合理
- [ ] 小栈确认：技术方案可行，集成点明确

**确认后开始 Step 1 开发。**
